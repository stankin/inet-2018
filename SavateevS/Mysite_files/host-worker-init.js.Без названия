!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("lodash")):"function"==typeof define&&define.amd?define(["lodash"],t):"object"==typeof exports?exports["host-worker-init"]=t(require("lodash")):e["host-worker-init"]=t(e.lodash)}(this,function(e){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(n,o,function(t){return e[t]}.bind(null,o));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=14)}([function(t,r){t.exports=e},,function(e,t,r){"use strict";e.exports={APPS:{SANTA_MEMBERS:{appDefId:"14cc59bc-f0b7-15b8-e1c7-89ce41d0e0c9"},FORM_BUILDER:{appDefId:"14ce1214-b278-a7e4-1373-00cebd1bef7c"}},WIX_CODE_NAMESPACES_AND_ELEMENTORY_SUPPORT_PATH:"/wixCodeNamespacesAndElementorySupport.min.js",DATA_BINDING:"dataBinding",SEMI_NATIVE_SDK_URL:"http://static.parastorage.com/services/semi-native-sdk/1.3.0/lib/wix.min.js",PM_RPC_INTENTS:{INVOKE:"invoke",RPC_RESOLVE:"rpc-resolve",RPC_REJECT:"rpc-reject",API_DESCRIPTION:"api-desc",INVOKE_FUNCTION:"invoke-func",RESOLVE:"resolve",REJECT:"reject",REQUEST_API:"request-api"},WIX_CODE:{MESSAGE_INTENT:{WIX_CODE_MESSAGE:"WIX_CODE",WIX_CODE_SITE_API:"WIX_CODE_SITE_API",WIX_CODE_APP_API:"WIX_CODE_APP_API",SANTA_APPLICATION_CHANNEL_MESSAGE_RESPONSE:"SANTA_APPLICATION_CHANNEL_MESSAGE_RESPONSE",SANTA_APPLICATION_CHANNEL_MESSAGE:"SANTA_APPLICATION_CHANNEL_MESSAGE"},MESSAGE_TYPE:{CONSOLE:"console",IFRAME_COMMAND:"wix_code_iframe_command",GOOGLE_ANALYTICS:"googleAnalytics",UPDATE_WIX_CODE_MODEL_DATA_AFTER_LOGIN:"update_wix_code_model_data_after_login",REQUEST_API:"REQUEST_API",PERFORMANCE_METRICS_READY:"performance_metrics_ready",PLATFORM_PUBLIC_API_PREFIX:"viewer_platform_public_api_",OPEN_MESSAGE_CHANNEL:"openMessageChannel",SANTA_READY:"santaReady",SANTA_PAGE_CHANGE:"santaPageChange"}}}},,,,function(e,t,r){"use strict";var n=r(0),o=r(15),s="platform_app_";function i(e){var t={},r=Object.keys(e).filter(function(e){return"string"==typeof e&&n.startsWith(e,s)}),o=!0,i=!1,a=void 0;try{for(var u,c=r[Symbol.iterator]();!(o=(u=c.next()).done);o=!0){var d=u.value;t[d.replace(s,"")]=e.getItem(d)}}catch(e){i=!0,a=e}finally{try{!o&&c.return&&c.return()}finally{if(i)throw a}}return t}e.exports={get:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0]?window:{localStorage:new o,sessionStorage:new o};return{serialize:function(){return JSON.stringify({local:i(e.localStorage),session:i(e.sessionStorage)})},setItem:function(t,r,n){e[t].setItem(s+r,n)}}}}},function(e,t,r){"use strict";var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}();var o=r(0),s=r(6),i=r(16),a=r(2);function u(){return"undefined"==typeof window||window.isPseudoWindow}function c(e,t,r){var n=0;return u()||(r=r&&window.fetch&&!function(e){return e.navigator&&/Edge|Trident/.test(e.navigator.userAgent)}(window),o.forEach(e,function(e){if(r&&o.includes(e.url,"parastorage"))++n,window.fetch(e.url).then(function(e){return e.arrayBuffer()}).then(function(r){t.postMessage(i.scriptImportMessage(e.url,r),[r])});else{var s="prefetch-"+e.id;if(!window.document.getElementById(s)){var a=window.document.createElement("link");a.setAttribute("rel","prefetch"),a.setAttribute("href",e.url),a.setAttribute("id",s),window.document.head.appendChild(a)}}})),n}function d(e){if(!this._standbyWorker){var t=new window.Worker(this._hostProps.workerUrl);t.addEventListener("message",this.onmessage),this._standbyWorker=t,function(e){var t=this._options.applications,r=this._hostProps,n=r.viewerSessionId,s=r.visitorId,d=r.initialTimestamp,l=r.metaSiteId,p=r.openExperiments,f=r.baseVersion,_=r.ownerId,g=r.santaBase,h={id:"sdk",url:this._options.sdkSource},m={id:"namespaces-sdk",url:this._options.namespacesSdkSource},E={id:"external-components",url:this._options.externalComponentsSource},w={id:"wixCodeNamespacesAndElementorySupport",url:this._options.wixCodeNamespacesAndElementorySupportSource},y=c(function(e,t,r){var n=o.clone(e);return t.some(function(e){return e.id===a.DATA_BINDING})&&(n=n.concat(r)),n.concat(t)}([h,m,E],t,w),this._standbyWorker,e);this._standbyWorker.postMessage(i.bootstrapMessage({sdkParameters:function(){var e="undefined"!=typeof window&&!window.clientSideRender,t=u();return{viewMode:this._hostProps.viewMode,locale:this._hostProps.locale,storage:this._storageManager.serialize(),userWarmup:this._hostProps.userWarmup,renderCycle:e&&!t?2:1,renderingEnv:t?"backend":"browser"}}.call(this),debug:window.__WIX_CODE_DEBUG__,santaVersion:f,wixCodeBase:g+"/node_modules/santa-wix-code",sdkSource:h.url,namespacesSdkSource:m.url,externalComponentsSource:E.url,applications:JSON.stringify(t),wixCodeNamespacesAndElementorySupportSource:w.url,viewerSessionId:n,visitorId:s,ownerId:_,initialTimestamp:d,metaSiteId:l,openExperiments:p},y))}.call(this,!!e)}}function l(e){this._workers[e]=this._standbyWorker,this._reportWorkerCreated(e),this._standbyWorker=null}function p(e,t){var r=this;return e.reduce(function(e,n){return o.assign(e,function(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}({},n,r._hostProps.getUserCodeUrlsDetails(t,n)))},{})}function f(e){var t=this;return function(r){var n=r.data;o.isMatch(n,{intent:"BROWSER_API",type:"setToStorage"})&&function(e){var t=this,r=e.type,n=e.key,s=e.value;this._storageManager.setItem(r,n,s);var a=i.storageWasUpdatedMessage(this._storageManager.serialize());o.forEach(this._workers,function(e,r){t.send(r,a)})}.call(t,n.data),e(r)}}function _(e,t){var r=[],n=o.find(e,{id:t});return n&&r.push(function(e){var t=e.appConfig.userScript;return{id:e.id,url:t.url,scriptName:t.scriptName,displayName:t.displayName,routerData:e.routerData}}(n)),r}var g=function(){function e(t,r,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._hostProps=function(e){var t={getElementoryArguments:function(){return null},getUserCodeUrlsDetails:_,loadUserCode:!0,viewMode:"site",locale:"",userWarmup:null,workerUrl:"",santaBase:"",baseVersion:"",ownerId:"",viewerSessionId:"",visitorId:"",initialTimestamp:null,metaSiteId:null,openExperiments:[]};return o.assign({},t,e)}(t),this._options=n,this._workers={},this._terminatedWorkers={},this._standbyWorker=null,this._storageManager=r}return n(e,[{key:"has",value:function(e){return Boolean(this._workers[e])}},{key:"initialize",value:function(e,t,r,n){this.onmessage=function(e){return function(t){var r=t.data,n=t.ports;o.includes(a.PM_RPC_INTENTS,r.intent)&&window.postMessage(r,"*",n),e(t)}}.call(this,f.call(this,function(t){var r=t.data;return e(r)})),this._reportWorkerCreated=t,this._reportWorkerTerminated=r,d.call(this,n)}},{key:"send",value:function(e,t,r){var n=i.isStopMessage(t)?this._terminatedWorkers[e]:this._workers[e];n&&(r?n.postMessage(t,r):n.postMessage(t))}},{key:"get",value:function(e){return this._workers[e]}},{key:"handleWidgetsCommand",value:function(e,t){var r=this;switch(e.type){case"load_user_code":if(!this._hostProps.loadUserCode)break;(function(e){var t=this;Object.keys(e).forEach(function(r){var n=e[r];c(n),t.has(r)||(d.call(t),l.call(t,r)),t.send(r,i.loadUserCodeMessage(r,n))})}).call(this,p.call(this,e.rootIds,e.widgets));break;case"load_widgets":(function(e){var t=this,r=e.applications,n=e.rootIds,o=e.wixCodeScriptsByRootId,s=e.elementoryArguments,a=e.routersMap,u=e.sdkParameters,c=e.rgisByRootId;n.forEach(function(e){t.has(e)||(d.call(t),l.call(t,e)),t.send(e,i.loadMessage(e,s,o[e],r,u,a,t._storageManager.serialize(),c[e]))})}).call(this,{applications:o.reject(e.widgets,o.overSome({type:"Page"},{type:"Popup"},{type:"masterPage"})),rootIds:e.rootIds,wixCodeScriptsByRootId:p.call(this,e.rootIds,e.widgets),elementoryArguments:this._hostProps.getElementoryArguments(e.widgets),routersMap:e.routersMap,sdkParameters:e.sdkParameters,rgisByRootId:e.rgisByRootId});break;case"init_widgets":o.forEach(e.contexts,function(e,t){if(!r.has(t))throw new Error("Context id "+t+" is not loaded");r.send(t,i.initMessage(t,e))});break;case"start_widgets":if(!e.contexts)throw new Error("Start message must contain contexts property");o.forEach(e.contexts,function(e,t){if(!r.has(t))throw new Error("Context id "+t+" is not loaded");r.send(t,i.startMessage(e,t))});break;case"trigger_onRender":d.call(this),this.send(e.contextId,e);break;case"stop_widgets":o.forEach(e.widgetIds,function(e){(function(e){var t=this,r=this._workers[e];return!!r&&(delete this._workers[e],this._terminatedWorkers[e]=r,o.defer(function(){t.send(e,i.stopMessage(e)),delete t._terminatedWorkers[e]}),!0)}).call(r,e)&&r._reportWorkerTerminated(e)});break;case"update_wix_code_model_data_after_login":o.forEach(e.rootIds,function(t){r.send(t,i.updateWixCodeModelDataAfterLoginMessage(t,r._hostProps.getElementoryArguments(e.widgets)))});break;default:this.has(e.contextId)&&this.send(e.contextId,e,t)}}},{key:"terminateStandbyWorker",value:function(){this._standbyWorker&&(this._standbyWorker.terminate(),this._standbyWorker=null)}}]),e}();e.exports={getWorkerManager:function(e,t,r){return new g(e,s.get(t),r)}}},function(e,t,r){"use strict";e.exports={get:function(){var e=[],t=null;return{sendOrHoldMessage:function(r,n){t?t(r,n):e.push({message:r,ports:n})},setMessageHandler:function(r){for(t=r;e.length>0;){var n=e.shift();t(n.message,n.ports)}}}}}},,,,,,function(e,t,r){"use strict";var n=r(6),o=r(7),s=r(2),i=r(17),a=r(8);e.exports={storageFacade:n,constants:s,workerMessagesService:i,messageProxy:a,workerManagerFactory:o}},function(e,t,r){"use strict";var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}();var o=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return n(e,[{key:"setItem",value:function(e,t){this[e]=String(t)}},{key:"getItem",value:function(e){return this[e]||null}},{key:"removeItem",value:function(e){delete this[e]}},{key:"clear",value:function(){var e=this;Object.keys(this).forEach(function(t){return e.removeItem(t)})}},{key:"toJSON",value:function(){return this.storage.toJSON()}}]),e}();e.exports=o},function(e,t,r){"use strict";e.exports={bootstrapMessage:function(e,t){return{type:"wix_code_worker_bootstrap",bootstrapArguments:e,fetchScriptsCount:t}},loadUserCodeMessage:function(e,t){return{type:"wix_code_worker_load_user_code",workerId:e,wixCode:t}},loadMessage:function(e,t,r,n,o,s,i,a){return{type:"wix_code_worker_load",workerId:e,elementoryArguments:t,wixCode:r,applications:n,sdkParameters:o,routersMap:s,storage:i,rgi:a}},initMessage:function(e,t){return{type:"wix_code_worker_init",id:e,apps:t}},startMessage:function(e,t){return{type:"wix_code_worker_start",context:e,id:t}},storageWasUpdatedMessage:function(e){return{type:"storageWasUpdated",storageValue:e}},updateWixCodeModelDataAfterLoginMessage:function(e,t){return{type:"update_wix_code_model_data_after_login",workerId:e,elementoryArguments:t}},scriptImportMessage:function(e,t){return{type:"script_import_message",url:e,script:t}},stopMessage:function(e){return{contextId:e,type:"stop"}},isStopMessage:function(e){return"stop"===e.type}}},function(e,t,r){"use strict";var n=r(0),o=r(7),s=r(8),i=r(2);e.exports={getAPI:function(){var e=s.get(),t=[],r=[],a=!1,u=void 0;function c(e,r){n.invoke(e,"shouldUseFallbackReportBI",r,t)&&n.invoke(e,"reportBiWithWixBiSession",r),t.forEach(function(e){e(r)})}return{init:function(t){var r=function(e){return n.assign({applications:[],reportWorkerCreated:n.noop,reportWorkerTerminated:n.noop,fetchScripts:!0},e)}(t),s=r.workerProps,i=r.fetchScripts;(u=o.getWorkerManager(s,function(){try{return window.localStorage.setItem("",""),window.localStorage.removeItem(""),!0}catch(e){return!1}}(),r)).initialize(n.partial(c,r),r.reportWorkerCreated,r.reportWorkerTerminated,i),e.setMessageHandler(function(e,t){return u.handleWidgetsCommand(e,t)}),a=!0},sendMessage:function(t,o){var s={intent:i.WIX_CODE.MESSAGE_INTENT.WIX_CODE_MESSAGE};(t=n.defaults({},t,s))&&e.sendOrHoldMessage(function(e){return r.reduce(function(e,t){return t(e)},e)}(t),o)},sendOrHoldMessage:function(t){e.sendOrHoldMessage(t)},registerMessageHandler:function(e){t.push(e)},registerMessageModifier:function(e){r.push(e)},isAppInitiated:function(){return a},getWorkerById:function(e){return u&&u.get(e)},destroyAppsContainer:function(){u&&(u.terminateStandbyWorker(),a=!1,e=s.get())}}}}}])});
//# sourceMappingURL=host-worker-init.js.map